<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KQL</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', 'Montserrat', sans-serif; }
    .glass {
      background: rgba(255,255,255,0.7);
      backdrop-filter: blur(12px);
      box-shadow: 0 8px 32px 0 rgba(31,38,135,0.12);
    }
    .gradient {
      background: linear-gradient(90deg, #6366f1 0%, #a21caf 100%);
    }
    .card {
      transition: box-shadow 0.2s, transform 0.2s;
    }
    .card:hover {
      box-shadow: 0 8px 32px 0 rgba(99,102,241,0.18);
      transform: translateY(-2px) scale(1.02);
    }
    .fadein { animation: fadein 0.5s; }
    @keyframes fadein { from { opacity: 0; transform: translateY(16px);} to { opacity: 1; transform: none; } }
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-white to-purple-100 dark:from-gray-900 dark:via-gray-950 dark:to-gray-900 min-h-screen">
  <header class="gradient py-10 px-4 flex flex-col items-center justify-center shadow-lg">
    <div class="flex flex-col items-center gap-2">
      <span class="text-5xl font-extrabold text-white tracking-tight drop-shadow-lg">KQLs</span>
    </div>
  </header>
  <main class="max-w-3xl mx-auto px-4 py-10">
    <div class="flex justify-center mb-10">
      <div class="glass rounded-full px-6 py-3 flex items-center w-full max-w-xl shadow-lg border border-indigo-100 focus-within:ring-2 focus-within:ring-indigo-400">
        <svg class="h-6 w-6 text-indigo-400 mr-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-2-2"/></svg>
        <input id="search" type="text" placeholder="Search resources, tags, or URLs..." class="flex-1 bg-transparent outline-none text-gray-800 dark:text-gray-100 placeholder-gray-400 text-lg" />
      </div>
    </div>
    <div id="loading" class="flex flex-col gap-8 my-16">
      <div class="animate-pulse h-8 w-1/4 bg-indigo-200 rounded"></div>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
        <div class="animate-pulse h-24 bg-purple-200 rounded-xl"></div>
        <div class="animate-pulse h-24 bg-pink-200 rounded-xl"></div>
      </div>
    </div>
    <div id="categories" class="mt-8"></div>
  </main>
  <footer class="text-center text-xs text-gray-400 py-8">&copy; <span id="year"></span> Made By Khalil Alqisy (KQG)</footer>
  <script type="module">
    import { db } from './firebase-config.js';
    import { collection, getDocs, onSnapshot, updateDoc, doc, increment } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const loading = document.getElementById('loading');
    const categoriesDiv = document.getElementById('categories');
    const searchInput = document.getElementById('search');
    document.getElementById('year').textContent = new Date().getFullYear();

    let openCategory = null;
    let allCategories = [];
    let allLinks = [];
    let searchTerm = '';
    let focusedCatIdx = 0;
    let focusedLinkIdx = 0;

    function focusCategory(idx) {
      const catSections = categoriesDiv.querySelectorAll('section');
      if (catSections[idx]) {
        catSections[idx].querySelector('button').focus();
        focusedCatIdx = idx;
        focusedLinkIdx = 0;
      }
    }
    function focusLink(catIdx, linkIdx) {
      const catSections = categoriesDiv.querySelectorAll('section');
      if (catSections[catIdx]) {
        const links = catSections[catIdx].querySelectorAll('li a');
        if (links[linkIdx]) {
          links[linkIdx].focus();
          focusedCatIdx = catIdx;
          focusedLinkIdx = linkIdx;
        }
      }
    }
    categoriesDiv.addEventListener('keydown', e => {
      const catSections = categoriesDiv.querySelectorAll('section');
      if (!catSections.length) return;
      if (document.activeElement.tagName === 'INPUT') return;
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (document.activeElement.tagName === 'BUTTON') {
          focusLink(focusedCatIdx, 0);
        } else {
          const links = catSections[focusedCatIdx].querySelectorAll('li a');
          if (focusedLinkIdx < links.length - 1) {
            focusLink(focusedCatIdx, focusedLinkIdx + 1);
          } else if (focusedCatIdx < catSections.length - 1) {
            focusCategory(focusedCatIdx + 1);
          }
        }
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (document.activeElement.tagName === 'A') {
          if (focusedLinkIdx > 0) {
            focusLink(focusedCatIdx, focusedLinkIdx - 1);
          } else {
            focusCategory(focusedCatIdx);
          }
        } else if (focusedCatIdx > 0) {
          focusCategory(focusedCatIdx - 1);
        }
      } else if (e.key === 'Enter') {
        if (document.activeElement.tagName === 'A') {
          document.activeElement.click();
        } else if (document.activeElement.tagName === 'BUTTON') {
          catSections[focusedCatIdx].querySelector('button').click();
        }
      }
    });

    function getLikedLinks() {
      try {
        return JSON.parse(localStorage.getItem('likedLinks') || '{}');
      } catch { return {}; }
    }
    function setLikedLinks(obj) {
      localStorage.setItem('likedLinks', JSON.stringify(obj));
    }
    
    function getClickedLinks() {
      try {
        return JSON.parse(localStorage.getItem('clickedLinks') || '{}');
      } catch { return {}; }
    }
    function setClickedLinks(obj) {
      localStorage.setItem('clickedLinks', JSON.stringify(obj));
    }
    
    let likedLinks = getLikedLinks();
    let clickedLinks = getClickedLinks();

    categoriesDiv.addEventListener('click', function(e) {
      if (e.target.tagName === 'A' && e.target.href) {
        const linkId = e.target.dataset.linkId;
        if (linkId) {
          clickedLinks = getClickedLinks();
          if (!clickedLinks[linkId]) {
            console.log('Tracking unique click for link ID:', linkId);
            updateDoc(doc(db, 'links', linkId), { clicks: increment(1) }).catch((err) => {
              console.error('Failed to update click count:', err);
            });
            clickedLinks[linkId] = 1;
            setClickedLinks(clickedLinks);
          } else {
            console.log('User already clicked this link before:', linkId);
          }
        }
      }
      if (e.target.closest('.like-btn')) {
        const btn = e.target.closest('.like-btn');
        const linkId = btn.dataset.id;
        if (linkId) {
          likedLinks = getLikedLinks();
          const liked = !!likedLinks[linkId];
          if (!liked) {
            updateDoc(doc(db, 'links', linkId), { likes: increment(1) }).catch(()=>{});
            likedLinks[linkId] = 1;
          } else {
            updateDoc(doc(db, 'links', linkId), { likes: increment(-1) }).catch(()=>{});
            delete likedLinks[linkId];
          }
          setLikedLinks(likedLinks);
          renderCategories(allCategories, allLinks);
        }
      }
    });

    searchInput.addEventListener('input', e => {
      searchTerm = e.target.value.toLowerCase();
      renderCategories(allCategories, allLinks);
    });

    function listenToCategoriesAndLinks() {
      let cats = [];
      let links = [];
      let catsLoaded = false;
      let linksLoaded = false;
      function tryRender() {
        if (catsLoaded && linksLoaded) {
          loading.style.display = 'none';
          allCategories = cats;
          allLinks = links;
          likedLinks = getLikedLinks();
          clickedLinks = getClickedLinks();
          renderCategories(cats, links);
        }
      }
      onSnapshot(collection(db, "categories"), (catSnap) => {
        cats = [];
        catSnap.forEach(doc => {
          cats.push({ id: doc.id, ...doc.data() });
        });
        cats.sort((a, b) => (a.order ?? 0) - (b.order ?? 0));
        catsLoaded = true;
        tryRender();
      });
      onSnapshot(collection(db, "links"), (linkSnap) => {
        links = [];
        linkSnap.forEach(doc => {
          links.push({ id: doc.id, ...doc.data() });
        });
        linksLoaded = true;
        tryRender();
      });
    }

    function renderCategories(categories, links) {
      categoriesDiv.innerHTML = '';
      let visibleCategories = categories.filter(cat => {
        if (cat.hidden) return false;
        if (searchTerm) {
          const matchingLinks = links.filter(link =>
            link.categoryId === cat.id &&
            !link.hidden &&
            (link.name.toLowerCase().includes(searchTerm) || link.url.toLowerCase().includes(searchTerm))
          );
          return matchingLinks.length > 0;
        } else {
          const visibleLinks = links.filter(link => link.categoryId === cat.id && !link.hidden);
          return visibleLinks.length > 0;
        }
      });
      visibleCategories = visibleCategories.slice().sort((a, b) => (a.order ?? 0) - (b.order ?? 0));
      if (visibleCategories.length === 0) {
        categoriesDiv.innerHTML = `
          <div class="flex flex-col items-center justify-center py-12">
            <svg width="80" height="80" fill="none" viewBox="0 0 80 80"><circle cx="40" cy="40" r="38" stroke="#6366f1" stroke-width="4" fill="#EEF2FF"/><path d="M25 50c2-4 7-8 15-8s13 4 15 8" stroke="#6366f1" stroke-width="2" stroke-linecap="round"/><circle cx="32" cy="36" r="3" fill="#6366f1"/><circle cx="48" cy="36" r="3" fill="#6366f1"/></svg>
            <div class="text-gray-400 text-center mt-4">No categories found.<br/><span class='text-xs'>Try adding some links or changing your search.</span></div>
          </div>
        `;
        return;
      }
      visibleCategories.forEach((cat, idx) => {
        let filteredLinks = links.filter(link =>
          link.categoryId === cat.id &&
          !link.hidden &&
          (link.name.toLowerCase().includes(searchTerm) || link.url.toLowerCase().includes(searchTerm))
        );
        filteredLinks = filteredLinks.slice().sort((a, b) => (a.order ?? 0) - (b.order ?? 0));
        const isOpen = openCategory === idx;
        const section = document.createElement('section');
        section.className = "mb-4 shadow-sm rounded-lg overflow-hidden transition-all duration-300 ease-in-out animate-fadein";
        section.style.background = cat.color || '#6366f1';
        section.style.color = '#fff';
        section.innerHTML = `
          <button class="w-full flex items-center justify-between px-5 py-3 focus:outline-none group" aria-expanded="${isOpen}" tabindex="0" style="background: transparent; color: #fff;">
            <div class="flex items-center gap-3">
              <span class="w-2 h-2 rounded-full bg-purple-500"></span>
              <span class="text-base font-bold" style="color: #fff;">${cat.name}</span>
            </div>
            <svg class="h-5 w-5 text-gray-200 group-hover:text-indigo-100 transition-transform ${isOpen ? 'rotate-180' : ''}" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
          </button>
          <div class="accordion-content ${isOpen ? 'open' : 'closed'} px-5 pb-3" style="background: transparent; ${isOpen ? '' : 'max-height:0;'}">
            <ul class="divide-y divide-gray-100">
              ${filteredLinks.length === 0 ? `<li class='flex flex-col items-center py-6'><svg width="40" height="40" fill="none" viewBox="0 0 40 40"><circle cx="20" cy="20" r="18" stroke="#fff" stroke-width="2" fill="transparent"/><path d="M13 25c1-2 4-4 7-4s6 2 7 4" stroke="#fff" stroke-width="1.5" stroke-linecap="round"/><circle cx="16" cy="18" r="1.5" fill="#fff"/><circle cx="24" cy="18" r="1.5" fill="#fff"/></svg><div class='text-gray-100 text-xs mt-2'>No links found in this category.</div></li>` : filteredLinks.map(link => `
                <li class="py-3 flex items-center justify-between transition-all duration-200 ease-in-out animate-fadein">
                  <div class="flex items-center gap-3 flex-1 min-w-0">
                    <img src="https://www.google.com/s2/favicons?domain=${encodeURIComponent(link.url)}" alt="favicon" class="w-5 h-5 mr-1 rounded" onerror="this.style.display='none'" />
                    <div class="flex flex-col min-w-0">
                      <span class="font-medium" style="color: #fff;">${link.name}</span>
                      ${link.desc ? `<div class='text-xs mt-1'>${link.desc.split(',').map(tag => `<span class='inline-block bg-transparent text-white rounded px-2 py-0.5 mr-1 mb-1' style='background: transparent;'>${tag.trim()}</span>`).join('')}</div>` : ''}
                      <a href="${link.url}" target="_blank" class="text-sm underline truncate max-w-xs" tabindex="0" style="display:inline-block; max-width:220px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; color: #fff; text-decoration: underline;" data-link-id="${link.id}">${link.url}</a>
                    </div>
                  </div>
                  <div class="flex gap-2 items-center ml-4">
                    <button class="like-btn ml-2 focus:outline-none" data-id="${link.id}" title="Like this link" style="background: transparent; color: #fff;">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline" fill="${likedLinks[link.id] ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 20 20"><path d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"/></svg> <span class="like-count">${typeof link.likes === 'number' ? link.likes : 0}</span>
                    </button>
                  </div>
                </li>
              `).join('')}
            </ul>
          </div>
        `;
        section.querySelector('button').onclick = () => {
          openCategory = openCategory === idx ? null : idx;
          renderCategories(visibleCategories, links);
        };
        categoriesDiv.appendChild(section);
      });
    }

    listenToCategoriesAndLinks();
  </script>
</body>
</html> 